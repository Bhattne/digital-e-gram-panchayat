<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>E-Gram Panchayat | User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../css/dashboard.css">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- Custom CSS -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
    }
    .dashboard-container {
      max-width: 1200px;
      margin: 30px auto;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      transition: 0.3s;
    }
    #requestTable th, #requestTable td {
      vertical-align: middle;
    }
  </style>
</head>
<body>

<div class="dashboard-container">

  <!-- Greeting & Logout -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="animate__animated animate__fadeIn">Welcome, <span id="userName">User</span></h2>
    <button class="btn btn-danger" id="logoutBtn">Logout</button>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm p-4 text-center card-hover">
        <h5>Total Requests</h5>
        <h2 id="totalRequests">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-4 text-center card-hover">
        <h5>Pending Requests</h5>
        <h2 id="pendingRequests">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-4 text-center card-hover">
        <h5>Completed Requests</h5>
        <h2 id="completedRequests">0</h2>
      </div>
    </div>
  </div>

  <!-- Submit Request Form -->
  <div class="card shadow-sm p-4 mb-4 animate__animated animate__fadeInUp">
    <h4>Submit a Request</h4>
    <form id="requestForm">
      <div class="mb-3">
        <select id="requestType" class="form-select" required>
          <option value="">Select Type</option>
          <option value="Electricity">Electricity</option>
          <option value="Water">Water</option>
          <option value="Road">Road</option>
          <option value="Certificate">Certificate</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-3">
        <textarea id="requestMessage" class="form-control" rows="3" placeholder="Describe your issue/request..." required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Submit Request</button>
    </form>
  </div>

  <!-- User Requests Table -->
  <div class="card shadow-sm p-4 animate__animated animate__fadeInUp">
    <h4>My Requests</h4>
    <table class="table table-striped mt-3" id="requestTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Type</th>
          <th>Message</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="requestList">
        <!-- Requests will appear here -->
      </tbody>
    </table>
  </div>

  <!-- Profile Card -->
  <div class="card shadow-sm p-4 mt-4 animate__animated animate__fadeInUp">
    <h4>Profile</h4>
    <p><strong>Email:</strong> <span id="userEmail"></span></p>
    <p><strong>Name:</strong> <span id="userFullName"></span></p>
    <button class="btn btn-outline-primary" id="editProfileBtn">Edit Profile</button>
  </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Check if user is logged in
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html"; // redirect if not logged in
    } else {
      document.getElementById("userName").innerText = user.email;
      document.getElementById("userEmail").innerText = user.email;
      document.getElementById("userFullName").innerText = user.displayName || "N/A";

      // Load user requests
      db.collection("requests").where("uid", "==", user.uid).orderBy("timestamp", "desc").get()
        .then(snapshot => {
          let requests = snapshot.docs;
          document.getElementById("totalRequests").innerText = requests.length;
          let pending = requests.filter(r => r.data().status === "Pending").length;
          let completed = requests.filter(r => r.data().status === "Completed").length;
          document.getElementById("pendingRequests").innerText = pending;
          document.getElementById("completedRequests").innerText = completed;

          const requestList = document.getElementById("requestList");
          requestList.innerHTML = "";
          requests.forEach((doc, index) => {
            let data = doc.data();
            requestList.innerHTML += `
              <tr>
                <td>${index+1}</td>
                <td>${data.type}</td>
                <td>${data.message}</td>
                <td>${data.status}</td>
                <td>${new Date(data.timestamp?.seconds*1000).toLocaleDateString()}</td>
              </tr>
            `;
          });
        });
    }
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  });

  // Submit Request
  document.getElementById("requestForm").addEventListener("submit", e => {
    e.preventDefault();
    const user = auth.currentUser;
    const type = document.getElementById("requestType").value;
    const message = document.getElementById("requestMessage").value;

    if (!user) return alert("Please login first!");

    db.collection("requests").add({
      uid: user.uid,
      type: type,
      message: message,
      status: "Pending",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert("âœ… Request submitted successfully!");
      location.reload();
    }).catch(err => console.error(err));
  });
</script>

</body>
</html>
